import React, { useCallback, useEffect, useMemo, useState } from 'react';
import { 
  TrendingUp,
  Search,
  Filter,
  DollarSign,
  PlusCircle,
  FileSpreadsheet,
  CheckCircle,
  AlertCircle,
  Clock,
  Eye,
  Edit,
  Trash2,
  X,
  Receipt,
  CalendarIcon,
  Download,
  Loader2,
  PiggyBank,
  FileBarChart,
  ChevronDown,
  ChevronUp,
  ChevronLeft,
  FileText,
  Banknote,
  CreditCard,
  Percent,
  Hash,
  Smartphone,
  Building,
  Bell,
  ChevronRight,
  User,
  MoreHorizontal,
  Settings,
  Activity,
  BarChart3,
} from 'lucide-react';
import { useToastContext } from '../contexts/ToastContext';
import { useAuth } from '../contexts/AuthContext';
import { financialService } from '../services/financial.service';
import { clientService } from '../services/client.service';
import { calendarService } from '../services/calendar.service';
import { ClientSearchSelect } from './ClientSearchSelect';
import type {
  Agreement,
  AgreementStatus,
  FinancialStats,
  Installment,
  InstallmentStatus,
  PayInstallmentDTO,
} from '../types/financial.types';
import type { Client } from '../types/client.types';

const FinancialModule: React.FC = () => {
  const toast = useToastContext();
  const { user } = useAuth();
  const [loading, setLoading] = useState(true);
  const [stats, setStats] = useState<FinancialStats | null>(null);
  const [agreements, setAgreements] = useState<Agreement[]>([]);
  const [clients, setClients] = useState<Client[]>([]);
  const [isModalOpen, setIsModalOpen] = useState(false);
  const [formLoading, setFormLoading] = useState(false);
  const [selectedAgreement, setSelectedAgreement] = useState<Agreement | null>(null);
  const [isDetailsModalOpen, setIsDetailsModalOpen] = useState(false);
  const [installments, setInstallments] = useState<Installment[]>([]);
  const [loadingInstallments, setLoadingInstallments] = useState(false);
  const today = new Date().toISOString().split('T')[0];
  const [isPaymentModalOpen, setIsPaymentModalOpen] = useState(false);
  const [selectedInstallment, setSelectedInstallment] = useState<Installment | null>(null);
  const [paymentData, setPaymentData] = useState({
    paymentDate: today,
    paymentMethod: 'pix' as 'dinheiro' | 'pix' | 'transferencia' | 'cheque' | 'cartao_credito' | 'cartao_debito',
    paidValue: '',
    notes: '',
  });
  const currentMonth = useMemo(() => today.slice(0, 7), [today]);
  const [isReportModalOpen, setIsReportModalOpen] = useState(false);
  const [reportMonth, setReportMonth] = useState(new Date().toISOString().slice(0, 7));
  const [activeMonth, setActiveMonth] = useState(new Date().toISOString().slice(0, 7));
  const [searchTerm, setSearchTerm] = useState('');
  const [filterStatus, setFilterStatus] = useState<'all' | 'ativo' | 'concluido' | 'cancelado'>('all');
  const [filterPaymentStatus, setFilterPaymentStatus] = useState<'all' | 'with_pending' | 'fully_paid'>('all');
  const [allInstallments, setAllInstallments] = useState<(Installment & { agreement?: Agreement })[]>([]);
  const [showOverdueOnly, setShowOverdueOnly] = useState(false);
  const [isEditModalOpen, setIsEditModalOpen] = useState(false);
  const [editLoading, setEditLoading] = useState(false);
  const [editInitialLoading, setEditInitialLoading] = useState(false);
  const [editError, setEditError] = useState<string | null>(null);
  const [isIRModalOpen, setIsIRModalOpen] = useState(false);
  const [showAllCompleted, setShowAllCompleted] = useState(false);
  const [activeView, setActiveView] = useState<'overview' | 'agreements' | 'analytics'>('overview');
  const [showToolsMenu, setShowToolsMenu] = useState(false);
  const [showSettingsPanel, setShowSettingsPanel] = useState(false);
  const pendingStatuses: InstallmentStatus[] = ['pendente', 'vencido'];
  const [editForm, setEditForm] = useState({
    clientId: '',
    processId: '',
    title: '',
    description: '',
    notes: '',
    agreementDate: new Date().toISOString().split('T')[0],
    status: 'ativo' as AgreementStatus,
    totalValue: '',
    feeType: 'percentage' as 'percentage' | 'fixed',
    feePercentage: '',
    feeFixedValue: '',
    paymentType: 'installments' as 'installments' | 'upfront',
    installmentsCount: '1',
    firstDueDate: new Date().toISOString().split('T')[0],
    customInstallments: [] as { dueDate: string; value: string }[],
  });
  const [formData, setFormData] = useState({
    clientId: '',
    processId: '',
    title: '',
    description: '',
    agreementDate: today,
    totalValue: '',
    feeType: 'percentage' as 'percentage' | 'fixed',
    feePercentage: '40',
    feeFixedValue: '',
    paymentType: 'installments' as 'installments' | 'upfront',
    installmentsCount: '12',
    firstDueDate: today,
    notes: '',
    customInstallments: [] as { dueDate: string; value: string }[],
  });
  const [formError, setFormError] = useState<string | null>(null);

  const loadData = useCallback(async (month?: string) => {
    try {
      setLoading(true);
      const [statsData, agreementsData, clientsData, allInstallmentsData] = await Promise.all([
        financialService.getFinancialStats(month),
        financialService.listAgreements(),
        clientService.listClients(),
        financialService.listAllInstallments(),
      ]);
      
      // Enriquecer parcelas com dados do acordo
      const enrichedInstallments = allInstallmentsData.map(inst => {
        const agreement = agreementsData.find(a => a.id === inst.agreement_id);
        return { ...inst, agreement };
      });
      
      setStats(statsData);
      setAgreements(agreementsData);
      setClients(clientsData);
      setAllInstallments(enrichedInstallments);
    } catch (err: any) {
      toast.error('Erro ao carregar', err.message);
    } finally {
      setLoading(false);
    }
  }, [toast]);

  useEffect(() => {
    loadData(activeMonth);
  }, [activeMonth, loadData]);

  useEffect(() => {
    if (stats?.overdue_installments) {
      setShowOverdueOnly(true);
    }
  }, [stats?.overdue_installments]);

  const formatCurrency = (value: number) => {
    return new Intl.NumberFormat('pt-BR', {
      style: 'currency',
      currency: 'BRL',
    }).format(value);
  };

  const getInstallmentFeeValue = (installment: Installment & { agreement?: Agreement }) => {
    if (installment.agreement && installment.agreement.installments_count) {
      return installment.agreement.fee_value / installment.agreement.installments_count;
    }
    return installment.paid_value ?? installment.value ?? 0;
  };

  const getClientName = (clientId: string) => {
    const client = clients.find(c => c.id === clientId);
    return client?.full_name || (client as any)?.name || 'Cliente n√£o encontrado';
  };

  const numberToWords = (value: number) => {
    const units = ['', 'um', 'dois', 'tr√™s', 'quatro', 'cinco', 'seis', 'sete', 'oito', 'nove'];
    const teens = ['dez', 'onze', 'doze', 'treze', 'quatorze', 'quinze', 'dezesseis', 'dezessete', 'dezoito', 'dezenove'];
    const tens = ['', '', 'vinte', 'trinta', 'quarenta', 'cinquenta', 'sessenta', 'setenta', 'oitenta', 'noventa'];
    const hundreds = ['', 'cento', 'duzentos', 'trezentos', 'quatrocentos', 'quinhentos', 'seiscentos', 'setecentos', 'oitocentos', 'novecentos'];

    const convertGroup = (n: number): string => {
      if (n === 0) return '';
      if (n === 100) return 'cem';
      
      const h = Math.floor(n / 100);
      const t = Math.floor((n % 100) / 10);
      const u = n % 10;
      
      let words = [];
      
      if (h > 0) words.push(hundreds[h]);
      
      if (t === 1) {
        words.push(teens[u]);
      } else {
        if (t > 0) words.push(tens[t]);
        if (u > 0) words.push(units[u]);
      }
      
      return words.join(' e ');
    };

    if (value === 0) return 'zero reais';
    
    const billions = Math.floor(value / 1000000000);
    const millions = Math.floor((value % 1000000000) / 1000000);
    const thousands = Math.floor((value % 1000000) / 1000);
    const remainder = Math.floor(value % 1000);
    const cents = Math.round((value % 1) * 100);
    
    let words = [];
    
    if (billions > 0) {
      words.push(`${convertGroup(billions)} ${billions === 1 ? 'bilh√£o' : 'bilh√µes'}`);
    }
    
    if (millions > 0) {
      words.push(`${convertGroup(millions)} ${millions === 1 ? 'milh√£o' : 'milh√µes'}`);
    }
    
    if (thousands > 0) {
      words.push(`${convertGroup(thousands)} mil`);
    }
    
    if (remainder > 0) {
      words.push(convertGroup(remainder));
    }
    
    const reais = words.join(' e ') + ' ' + (value === 1 ? 'real' : 'reais');
    
    if (cents > 0) {
      return `${reais} e ${convertGroup(cents)} ${cents === 1 ? 'centavo' : 'centavos'}`;
    }
    
    return reais;
  };

  const filteredAgreements = useMemo(() => {
    return agreements.filter(agreement => {
      const matchesSearch = 
        agreement.title.toLowerCase().includes(searchTerm.toLowerCase()) ||
        getClientName(agreement.client_id).toLowerCase().includes(searchTerm.toLowerCase());
      const matchesStatus = filterStatus === 'all' || agreement.status === filterStatus;
      
      // Filtro por status de pagamento
      let matchesPaymentStatus = true;
      if (filterPaymentStatus !== 'all') {
        const agreementInstallments = allInstallments.filter(inst => inst.agreement_id === agreement.id);
        const hasPending = agreementInstallments.some(inst => pendingStatuses.includes(inst.status as InstallmentStatus));
        
        if (filterPaymentStatus === 'with_pending') {
          matchesPaymentStatus = hasPending;
        } else if (filterPaymentStatus === 'fully_paid') {
          matchesPaymentStatus = !hasPending && agreementInstallments.length > 0;
        }
      }
      
      return matchesSearch && matchesStatus && matchesPaymentStatus;
    });
  }, [agreements, searchTerm, filterStatus, filterPaymentStatus, clients, allInstallments]);

  const nextDueInstallment = useMemo(() => {
    const pending = allInstallments
      .filter(inst => pendingStatuses.includes(inst.status as InstallmentStatus))
      .sort((a, b) => a.due_date.localeCompare(b.due_date));
    if (!pending.length) return null;
    const upcoming = pending.find(inst => inst.due_date >= today);
    return upcoming || pending[0];
  }, [allInstallments, today]);

  const nextDueInfo = useMemo(() => {
    if (!nextDueInstallment) return null;
    const dueDateObj = new Date(`${nextDueInstallment.due_date}T00:00:00`);
    const todayObj = new Date(`${today}T00:00:00`);
    const diffDays = Math.round((dueDateObj.getTime() - todayObj.getTime()) / (1000 * 60 * 60 * 24));
    let relativeLabel = '';
    if (diffDays === 0) relativeLabel = 'Hoje';
    else if (diffDays === 1) relativeLabel = 'Amanh√£';
    else if (diffDays > 1) relativeLabel = `Em ${diffDays} dias`;
    else if (diffDays === -1) relativeLabel = 'Ontem';
    else relativeLabel = `H√° ${Math.abs(diffDays)} dias`;

    return {
      installment: nextDueInstallment,
      dueDateFormatted: dueDateObj.toLocaleDateString('pt-BR'),
      relativeLabel,
    };
  }, [nextDueInstallment, today]);

  const availableYears = useMemo(() => {
    const years = new Set<number>();
    allInstallments.forEach(inst => {
      if (inst.status === 'pago' && inst.payment_date) {
        const year = new Date(inst.payment_date).getFullYear();
        years.add(year);
      }
    });
    return Array.from(years).sort((a, b) => b - a); // Ordem decrescente
  }, [allInstallments]);

  const handleOpenEditModal = async (agreement: Agreement) => {
    setEditError(null);
    setSelectedAgreement(agreement);
    setIsEditModalOpen(true);
    setEditInitialLoading(true);

    try {
      const installmentsData = await financialService.listInstallments(agreement.id);
      const customFromAgreement = agreement.custom_installments?.length
        ? agreement.custom_installments
        : undefined;

      const customInstallments = customFromAgreement
        ? customFromAgreement.map((item) => ({ dueDate: item.due_date, value: item.value.toFixed(2) }))
        : installmentsData.map((inst) => ({ dueDate: inst.due_date, value: inst.value.toFixed(2) }));

      setEditForm({
        clientId: agreement.client_id,
        processId: agreement.process_id || '',
        title: agreement.title,
        description: agreement.description || '',
        notes: agreement.notes || '',
        agreementDate: agreement.agreement_date || today,
        status: agreement.status,
        totalValue: agreement.total_value.toString(),
        feeType: agreement.fee_type,
        feePercentage: agreement.fee_percentage?.toString() || '',
        feeFixedValue: agreement.fee_fixed_value?.toString() || '',
        paymentType: agreement.payment_type,
        installmentsCount: agreement.installments_count.toString(),
        firstDueDate: agreement.first_due_date,
        customInstallments,
      });
    } catch (err: any) {
      toast.error('Erro ao abrir edi√ß√£o', err.message);
    } finally {
      setEditInitialLoading(false);
    }
  };

  const handleCloseEditModal = () => {
    setIsEditModalOpen(false);
    setEditLoading(false);
    setEditError(null);
    setEditInitialLoading(false);
  };

  const handleEditChange = (field: keyof typeof editForm, value: string) => {
    setEditForm((prev) => {
      if (field === 'paymentType') {
        const nextPayment = value as 'installments' | 'upfront';
        return {
          ...prev,
          paymentType: nextPayment,
          installmentsCount: nextPayment === 'upfront' ? '1' : (prev.installmentsCount || '1'),
          customInstallments: nextPayment === 'upfront' ? [] : prev.customInstallments,
        };
      }

      if (field === 'feeType') {
        const nextType = value as 'percentage' | 'fixed';
        return {
          ...prev,
          feeType: nextType,
          feePercentage: nextType === 'percentage' ? (prev.feePercentage || '40') : '',
          feeFixedValue: nextType === 'fixed' ? (prev.feeFixedValue || '') : '',
        };
      }

      return {
        ...prev,
        [field]: value,
      };
    });
  };

  const handleToggleEditCustomInstallments = () => {
    setEditForm((prev) => {
      const count = Number(prev.installmentsCount || '0');
      if (prev.customInstallments.length) {
        return { ...prev, customInstallments: [] };
      }

      if (!count || count <= 0) {
        return { ...prev };
      }

      const installments = Array.from({ length: count }, (_, index) => ({
        dueDate: index === 0 ? prev.firstDueDate : '',
        value: prev.totalValue && count ? (Number(prev.totalValue) / count).toFixed(2) : '',
      }));

      return { ...prev, customInstallments: installments };
    });
  };

  const handleEditCustomInstallmentChange = (index: number, field: 'dueDate' | 'value', value: string) => {
    setEditForm((prev) => ({
      ...prev,
      customInstallments: prev.customInstallments.map((item, idx) =>
        idx === index ? { ...item, [field]: value } : item
      ),
    }));
  };

  const handleEditRecalculateCustomInstallments = () => {
    setEditForm((prev) => {
      const count = Number(prev.installmentsCount || '0');
      if (!prev.customInstallments.length || !count || !prev.totalValue) {
        return prev;
      }

      const baseValue = Number(prev.totalValue) / count;
      return {
        ...prev,
        customInstallments: prev.customInstallments.map((item, index) => ({
          dueDate: index === 0 ? prev.firstDueDate : (prev.customInstallments[index - 1]?.dueDate || prev.firstDueDate),
          value: baseValue.toFixed(2),
        })),
      };
    });
  };

  const handleSubmitEdit = async (event: React.FormEvent) => {
    event.preventDefault();
    if (!selectedAgreement) return;

    if (!editForm.clientId) {
      setEditError('Selecione um cliente');
      return;
    }

    if (!editForm.title.trim()) {
      setEditError('Informe o t√≠tulo do acordo');
      return;
    }

    if (!editForm.totalValue || Number(editForm.totalValue) <= 0) {
      setEditError('Informe um valor total v√°lido');
      return;
    }

    if (editForm.feeType === 'percentage' && (!editForm.feePercentage || Number(editForm.feePercentage) <= 0)) {
      setEditError('Informe o percentual de honor√°rios');
      return;
    }

    if (editForm.feeType === 'fixed' && (!editForm.feeFixedValue || Number(editForm.feeFixedValue) <= 0)) {
      setEditError('Informe o valor fixo dos honor√°rios');
      return;
    }

    if (editForm.paymentType === 'installments') {
      if (!editForm.installmentsCount || Number(editForm.installmentsCount) < 2) {
        setEditError('Informe a quantidade de parcelas (m√≠nimo 2)');
        return;
      }

      if (!editForm.firstDueDate && !editForm.customInstallments.length) {
        setEditError('Informe a data da primeira parcela');
        return;
      }

      if (editForm.customInstallments.length) {
        if (editForm.customInstallments.length !== Number(editForm.installmentsCount)) {
          setEditError('N√∫mero de parcelas personalizadas diferente da quantidade informada');
          return;
        }

        const invalid = editForm.customInstallments.find((item) => !item.dueDate || !item.value || Number(item.value) <= 0);
        if (invalid) {
          setEditError('Preencha todas as datas e valores das parcelas personalizadas');
          return;
        }
      }
    }

    try {
      setEditLoading(true);
      setEditError(null);

      const customInstallmentsPayload = editForm.customInstallments.length
        ? editForm.customInstallments.map((item) => ({
            due_date: item.dueDate,
            value: Number(item.value),
          }))
        : undefined;

      const updated = await financialService.updateAgreement(selectedAgreement.id, {
        client_id: editForm.clientId,
        process_id: editForm.processId || null,
        title: editForm.title.trim(),
        description: editForm.description.trim() || undefined,
        agreement_date: editForm.agreementDate,
        status: editForm.status,
        notes: editForm.notes.trim() || undefined,
        total_value: Number(editForm.totalValue),
        fee_type: editForm.feeType,
        fee_percentage: editForm.feeType === 'percentage' ? Number(editForm.feePercentage) : undefined,
        fee_fixed_value: editForm.feeType === 'fixed' ? Number(editForm.feeFixedValue) : undefined,
        payment_type: editForm.paymentType,
        installments_count: editForm.paymentType === 'upfront' ? 1 : Number(editForm.installmentsCount),
        first_due_date: editForm.firstDueDate,
        custom_installments: customInstallmentsPayload,
      });

      setSelectedAgreement(updated);
      setAgreements((prev) => prev.map((item) => (item.id === updated.id ? updated : item)));
      toast.success('Acordo atualizado', 'As informa√ß√µes foram salvas com sucesso');
      handleCloseEditModal();
      loadData(activeMonth);
    } catch (err: any) {
      setEditError(err.message || 'N√£o foi poss√≠vel atualizar o acordo');
      setEditLoading(false);
    }
  };

  const agreementSummary = useMemo(() => {
    if (!selectedAgreement) return null;

    const hasInstallments = installments.length > 0;
    const totalInstallments = hasInstallments
      ? Number(installments.reduce((sum, inst) => sum + (inst.value || 0), 0).toFixed(2))
      : selectedAgreement.total_value;

    const totalValue = Number(totalInstallments.toFixed(2));
    const feeValue = selectedAgreement.fee_type === 'percentage'
      ? Number(((totalValue * (selectedAgreement.fee_percentage ?? 0)) / 100).toFixed(2))
      : Number(selectedAgreement.fee_value.toFixed(2));
    const netValue = Number((totalValue - feeValue).toFixed(2));

    const installmentsCount = hasInstallments
      ? installments.length
      : selectedAgreement.installments_count;
    const installmentValue = installmentsCount > 0
      ? Number((totalValue / installmentsCount).toFixed(2))
      : Number(selectedAgreement.installment_value.toFixed(2));

    return {
      totalValue,
      feeValue,
      netValue,
      installmentsCount,
      installmentValue,
    };
  }, [selectedAgreement, installments]);

  const handleOpenModal = () => {
    setFormError(null);
    setIsModalOpen(true);
  };

  const handleCloseModal = () => {
    setIsModalOpen(false);
    setFormError(null);
    setFormLoading(false);
    setFormData((prev) => ({
      ...prev,
      clientId: '',
      processId: '',
      title: '',
      description: '',
      totalValue: '',
      feeType: 'percentage',
      feePercentage: '40',
      feeFixedValue: '',
      paymentType: 'installments',
      installmentsCount: '12',
      firstDueDate: today,
      notes: '',
      customInstallments: [],
    }));
  };

  const handleChange = (field: keyof typeof formData, value: string) => {
    setFormData((prev) => {
      if (field === 'paymentType') {
        return {
          ...prev,
          paymentType: value as 'installments' | 'upfront',
          installmentsCount: value === 'upfront' ? '1' : prev.installmentsCount || '12',
          customInstallments: value === 'upfront' ? [] : prev.customInstallments,
        };
      }
      if (field === 'feeType') {
        return {
          ...prev,
          feeType: value as 'percentage' | 'fixed',
          feePercentage: value === 'percentage' ? (prev.feePercentage || '40') : '',
          feeFixedValue: value === 'fixed' ? (prev.feeFixedValue || '') : '',
        };
      }
      return { ...prev, [field]: value };
    });
  };

  const validateForm = () => {
    if (!formData.clientId) return 'Selecione um cliente';
    if (!formData.title.trim()) return 'Informe o t√≠tulo do acordo';
    if (!formData.totalValue || Number(formData.totalValue) <= 0) return 'Informe um valor total v√°lido';
    if (formData.feeType === 'percentage') {
      if (!formData.feePercentage || Number(formData.feePercentage) <= 0) return 'Informe o percentual de honor√°rios';
    } else {
      if (!formData.feeFixedValue || Number(formData.feeFixedValue) <= 0) return 'Informe o valor fixo de honor√°rios';
    }
    if (formData.paymentType === 'upfront' && !formData.firstDueDate) return 'Informe a data do pagamento';
    if (formData.paymentType === 'installments' && !formData.firstDueDate && !formData.customInstallments.length) return 'Informe a data da primeira parcela';
    if (formData.paymentType === 'installments') {
      if (!formData.installmentsCount || Number(formData.installmentsCount) < 2) return 'Informe a quantidade de parcelas (m√≠nimo 2)';
      if (formData.customInstallments.length) {
        if (formData.customInstallments.length !== Number(formData.installmentsCount)) return 'N√∫mero de parcelas personalizadas diferente da quantidade informada';
        const invalid = formData.customInstallments.find((item) => !item.dueDate || !item.value || Number(item.value) <= 0);
        if (invalid) return 'Preencha todas as datas e valores das parcelas personalizadas';
      }
    }
    return null;
  };

  const handleSubmit = async (event: React.FormEvent) => {
    event.preventDefault();
    const error = validateForm();
    if (error) {
      setFormError(error);
      return;
    }

    try {
      setFormLoading(true);
      setFormError(null);

      const createdAgreement = await financialService.createAgreement({
        client_id: formData.clientId,
        process_id: formData.processId || undefined,
        title: formData.title.trim(),
        description: formData.description?.trim() || undefined,
        agreement_date: formData.agreementDate,
        total_value: Number(formData.totalValue),
        fee_type: formData.feeType,
        fee_percentage: formData.feeType === 'percentage' ? Number(formData.feePercentage) : undefined,
        fee_fixed_value: formData.feeType === 'fixed' ? Number(formData.feeFixedValue) : undefined,
        payment_type: formData.paymentType,
        installments_count: formData.paymentType === 'upfront' ? 1 : Number(formData.installmentsCount),
        first_due_date: formData.firstDueDate || (formData.customInstallments[0]?.dueDate ?? today),
        custom_installments: formData.customInstallments.length
          ? formData.customInstallments.map((item) => ({
              due_date: item.dueDate,
              value: Number(item.value),
            }))
          : undefined,
        notes: formData.notes?.trim() || undefined,
      });

      const schedule = buildScheduleFromForm();
      if (schedule.length) {
        await createCalendarEventsForInstallments(createdAgreement, schedule);
      }

      toast.success('Acordo criado', 'Os dados foram registrados com sucesso');
      handleCloseModal();
      loadData();
    } catch (err: any) {
      toast.error('Erro ao criar acordo', err.message);
      setFormLoading(false);
    }
  };

  const handleOpenDetails = async (agreement: Agreement) => {
    setSelectedAgreement(agreement);
    setIsDetailsModalOpen(true);
    setLoadingInstallments(true);
    try {
      const installmentsData = await financialService.listInstallments(agreement.id);
      setInstallments(installmentsData);
      await ensureOverdueDeadlines(agreement, installmentsData);
    } catch (err: any) {
      toast.error('Erro ao carregar parcelas', err.message);
    } finally {
      setLoadingInstallments(false);
    }
  };

  const handleCloseDetails = () => {
    setIsDetailsModalOpen(false);
    setSelectedAgreement(null);
    setInstallments([]);
  };

  const handleOpenPaymentModal = (installment: Installment) => {
    setSelectedInstallment(installment);
    setPaymentData({
      paymentDate: today,
      paymentMethod: 'pix',
      paidValue: installment.value.toString(),
      notes: '',
    });
    setIsPaymentModalOpen(true);
  };

  const handleClosePaymentModal = () => {
    setIsPaymentModalOpen(false);
    setSelectedInstallment(null);
    setPaymentData({
      paymentDate: today,
      paymentMethod: 'pix',
      paidValue: '',
      notes: '',
    });
  };

  const handleConfirmPayment = async () => {
    if (!selectedInstallment || !selectedAgreement) return;
    
    if (!paymentData.paidValue || Number(paymentData.paidValue) <= 0) {
      toast.error('Erro', 'Informe o valor pago');
      return;
    }

    try {
      await financialService.payInstallment(selectedInstallment.id, {
        payment_date: paymentData.paymentDate,
        payment_method: paymentData.paymentMethod,
        paid_value: Number(paymentData.paidValue),
        notes: paymentData.notes || undefined,
      });

      await updateCalendarEventStatus(
        selectedAgreement.id,
        selectedInstallment.installment_number,
        'concluido',
        paymentData.paymentDate
      );
      
      toast.success('Pagamento registrado', 'Baixa realizada com sucesso');
      handleClosePaymentModal();
      
      // Recarregar parcelas
      const updatedInstallments = await financialService.listInstallments(selectedAgreement.id);
      setInstallments(updatedInstallments);
      await ensureOverdueDeadlines(selectedAgreement, updatedInstallments);
      loadData();
    } catch (err: any) {
      toast.error('Erro ao registrar pagamento', err.message);
    }
  };

  const checkOverdueInstallments = () => {
    const twoDaysAgo = new Date();
    twoDaysAgo.setDate(twoDaysAgo.getDate() - 2);
    const twoDaysAgoStr = twoDaysAgo.toISOString().split('T')[0];
    
    return installments.filter(
      inst => inst.status === 'pendente' && inst.due_date < twoDaysAgoStr
    );
  };

  const generateMonthlyReport = () => {
    setIsReportModalOpen(true);
  };

  const handleExportMonthlyReport = () => {
    const monthLabel = formatMonthYear(activeMonth).replace(/^./, (char) => char.toUpperCase());
    const issueDate = new Date().toLocaleDateString('pt-BR', {
      day: '2-digit',
      month: 'long',
      year: 'numeric',
    });

    const monthPayments = allInstallments
      .filter(
        (inst) =>
          inst.status === 'pago' &&
          inst.payment_date &&
          inst.payment_date.slice(0, 7) === activeMonth,
      )
      .map((inst) => {
        const clientName = getClientName(inst.agreement?.client_id || '');
        const agreementTitle = inst.agreement?.title || 'Acordo';
        const amount = getInstallmentFeeValue(inst);
        return {
          clientName,
          agreementTitle,
          paymentDate: inst.payment_date!,
          amount,
        };
      })
      .sort((a, b) => new Date(a.paymentDate).getTime() - new Date(b.paymentDate).getTime());

    const monthPending = allInstallments
      .filter(
        (inst) =>
          pendingStatuses.includes(inst.status as InstallmentStatus) &&
          inst.due_date &&
          inst.due_date.slice(0, 7) === activeMonth,
      )
      .map((inst) => ({
        clientName: getClientName(inst.agreement?.client_id || ''),
        agreementTitle: inst.agreement?.title || 'Acordo',
        dueDate: inst.due_date!,
        amount: inst.value,
      }))
      .sort((a, b) => new Date(a.dueDate).getTime() - new Date(b.dueDate).getTime());

    const totalReceived = monthPayments.reduce((sum, item) => sum + item.amount, 0);
    const totalPending = monthPending.reduce((sum, item) => sum + item.amount, 0);

    const html = `<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Relat√≥rio Mensal - ${monthLabel}</title>
  <style>
    @page { size: A4; margin: 12mm; }
    body {
      font-family: 'Inter', Arial, sans-serif;
      background: #f5f6f7;
      color: #0f172a;
      margin: 0;
      padding: 0;
    }
    .wrapper {
      max-width: 820px;
      margin: 0 auto;
      background: #fff;
      padding: 40px 48px;
      border: 1px solid #e2e8f0;
      box-shadow: 0 16px 40px rgba(15,23,42,0.08);
    }
    .doc-header {
      text-align: center;
      border-bottom: 4px double #0f172a;
      padding-bottom: 24px;
      margin-bottom: 24px;
    }
    .doc-header h1 {
      font-size: 24px;
      letter-spacing: 4px;
      text-transform: uppercase;
      margin: 0;
    }
    .doc-header p {
      margin: 6px 0 0;
      color: #475467;
      font-size: 13px;
    }
    .summary-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 16px;
      margin: 24px 0;
    }
    .summary-card {
      border: 1px solid #d7dde5;
      border-radius: 8px;
      padding: 14px;
      background: #f9fafb;
    }
    .summary-card span {
      display: block;
      font-size: 11px;
      letter-spacing: 1px;
      color: #475467;
      text-transform: uppercase;
    }
    .summary-card strong {
      display: block;
      font-size: 20px;
      margin-top: 6px;
      color: #0f172a;
    }
    h2 {
      font-size: 13px;
      letter-spacing: 1px;
      text-transform: uppercase;
      margin: 32px 0 12px;
      color: #0f172a;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
      margin-bottom: 16px;
    }
    table thead {
      background: #0f172a;
      color: #fff;
    }
    th, td {
      padding: 10px 12px;
      border: 1px solid #e2e8f0;
      text-align: left;
    }
    td.amount {
      text-align: right;
      font-weight: 600;
      color: #0f172a;
    }
    .empty-row td {
      text-align: center;
      color: #94a3b8;
      font-style: italic;
    }
    .notes {
      border: 1px solid #facc15;
      background: #fffbeb;
      border-radius: 8px;
      padding: 16px;
      font-size: 12px;
      color: #854d0e;
      line-height: 1.7;
    }
    .footer {
      margin-top: 32px;
      font-size: 11px;
      color: #94a3b8;
      text-align: center;
      border-top: 1px solid #e2e8f0;
      padding-top: 12px;
    }
    .print-btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      background: #0f172a;
      color: white;
      border: none;
      border-radius: 999px;
      padding: 10px 22px;
      font-weight: 600;
      cursor: pointer;
      margin-top: 24px;
    }
    @media print {
      body { background: #fff; }
      .wrapper { box-shadow: none; border: none; }
      .print-btn { display: none; }
    }
  </style>
</head>
<body>
  <div class="wrapper">
    <div class="doc-header">
      <p>Relat√≥rio Mensal Financeiro</p>
      <h1>${monthLabel.toUpperCase()}</h1>
      <p>Emitido em ${issueDate}</p>
    </div>
    <div class="summary-grid">
      <div class="summary-card">
        <span>Honor√°rios recebidos</span>
        <strong>${formatCurrency(totalReceived)}</strong>
        <small>${monthPayments.length} pagamento${monthPayments.length === 1 ? '' : 's'}</small>
      </div>
      <div class="summary-card">
        <span>Parcelas pendentes</span>
        <strong>${formatCurrency(totalPending)}</strong>
        <small>${monthPending.length} parcela${monthPending.length === 1 ? '' : 's'}</small>
      </div>
      <div class="summary-card">
        <span>Saldo projetado</span>
        <strong>${formatCurrency(totalReceived + totalPending)}</strong>
        <small>Recebido + pendente</small>
      </div>
    </div>

    <h2>Pagamentos registrados no m√™s</h2>
    <table>
      <thead>
        <tr>
          <th>Cliente</th>
          <th>Acordo</th>
          <th>Data</th>
          <th style="text-align:right;">Valor</th>
        </tr>
      </thead>
      <tbody>
        ${monthPayments.length > 0
          ? monthPayments
              .map(
                (payment) => `
        <tr>
          <td>${payment.clientName}</td>
          <td>${payment.agreementTitle}</td>
          <td>${new Date(payment.paymentDate).toLocaleDateString('pt-BR')}</td>
          <td class="amount">${formatCurrency(payment.amount)}</td>
        </tr>`,
              )
              .join('')
          : '<tr class="empty-row"><td colspan="4">Sem recebimentos registrados neste m√™s</td></tr>'}
      </tbody>
    </table>

    <h2>Parcelas pendentes no m√™s</h2>
    <table>
      <thead>
        <tr>
          <th>Cliente</th>
          <th>Acordo</th>
          <th>Vencimento</th>
          <th style="text-align:right;">Valor</th>
        </tr>
      </thead>
      <tbody>
        ${monthPending.length > 0
          ? monthPending
              .map(
                (pending) => `
        <tr>
          <td>${pending.clientName}</td>
          <td>${pending.agreementTitle}</td>
          <td>${new Date(pending.dueDate).toLocaleDateString('pt-BR')}</td>
          <td class="amount">${formatCurrency(pending.amount)}</td>
        </tr>`,
              )
              .join('')
          : '<tr class="empty-row"><td colspan="4">Sem pend√™ncias para este m√™s</td></tr>'}
      </tbody>
    </table>

    <div class="notes">
      <strong style="display:block; margin-bottom:8px; text-transform:uppercase;">Orienta√ß√µes</strong>
      <ul style="margin:0 0 0 16px; padding:0;">
        <li>Utilize este relat√≥rio como base para o acompanhamento financeiro mensal.</li>
        <li>Reforce a cobran√ßa de parcelas pendentes antes do vencimento.</li>
        <li>Mantenha os comprovantes arquivados para eventual auditoria.</li>
      </ul>
    </div>
    <div class="footer">
      Documento emitido automaticamente pelo sistema de gest√£o financeira.
    </div>
    <div style="text-align:center;">
      <button class="print-btn" onclick="window.print()">üñ®Ô∏è Imprimir relat√≥rio</button>
    </div>
  </div>
</body>
</html>`;

    const blob = new Blob([html], { type: 'text/html' });
    const url = URL.createObjectURL(blob);
    window.open(url, '_blank');
    toast.success('Relat√≥rio gerado', 'Relat√≥rio mensal aberto em nova aba');
  };

  const handleGenerateIRReport = async (year: number) => {
    try {
      // Buscar todos os pagamentos do ano
      const yearStart = `${year}-01-01`;
      const yearEnd = `${year}-12-31`;
      
      const allInstallmentsYear = allInstallments.filter(inst => 
        inst.status === 'pago' && 
        inst.payment_date && 
        inst.payment_date >= yearStart && 
        inst.payment_date <= yearEnd
      );

      // Agrupar por cliente
      const clientPayments = new Map<string, { client: any; payments: typeof allInstallmentsYear; total: number }>();
      
      allInstallmentsYear.forEach(inst => {
        if (!inst.agreement) return;
        const clientId = inst.agreement.client_id;
        const client = clients.find(c => c.id === clientId);
        
        if (!clientPayments.has(clientId)) {
          clientPayments.set(clientId, {
            client,
            payments: [],
            total: 0
          });
        }
        
        const entry = clientPayments.get(clientId)!;
        const feeValue = inst.agreement.fee_value / inst.agreement.installments_count;
        entry.payments.push(inst);
        entry.total += feeValue;
      });

      // Dados fixos do advogado
      const lawyerName = 'PEDRO RODRIGUES MONTALVAO NETO';
      const lawyerOab = '30.021';
      const lawyerState = 'MT';
      const lawyerEmail = 'pedro@advcuiaba.com';

      const totalReceived = Array.from(clientPayments.values()).reduce((sum, entry) => sum + entry.total, 0);
      const issueDate = new Date().toLocaleDateString('pt-BR', { day: '2-digit', month: 'long', year: 'numeric' });

      const html = `<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Relat√≥rio de Honor√°rios para Imposto de Renda ${year}</title>
  <link rel="preconnect" href="${window.location.origin}" />
  <link rel="dns-prefetch" href="${window.location.origin}" />
  <style>
    @page { size: A4; margin: 15mm; }
    @media print {
      html, body { margin: 0; padding: 0; background: white; }
      .no-print { display: none !important; }
      .report-container { 
        box-shadow: none !important;
        border: none !important;
        page-break-inside: avoid;
        margin: 0 !important;
        padding: 20mm !important;
      }
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Georgia', 'Times New Roman', serif;
      background: #f5f5f5;
      padding: 20px;
      color: #1a1a1a;
      line-height: 1.6;
    }
    .report-container {
      max-width: 210mm;
      margin: 0 auto;
      background: white;
      padding: 25mm 20mm;
      box-shadow: 0 4px 20px rgba(0,0,0,0.15);
      border: 2px solid #000;
      position: relative;
    }
    .hero-box {
      text-align: center;
      margin-bottom: 30px;
      padding-bottom: 20px;
      border-bottom: 3px double #000;
    }
    .lawyer-name {
      font-size: 18px;
      font-weight: 700;
      color: #000;
      margin: 10px 0 5px;
      letter-spacing: 0.5px;
    }
    .lawyer-oab {
      font-size: 14px;
      color: #333;
      font-weight: 600;
    }
    .header {
      text-align: center;
      padding: 20px;
      margin-bottom: 30px;
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
      border: 2px solid #000;
      border-radius: 8px;
    }
    .header h1 {
      font-size: 24px;
      color: #000;
      font-weight: 700;
      margin-bottom: 12px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    .header .year {
      font-size: 36px;
      font-weight: 900;
      color: #000;
      margin: 15px 0;
      letter-spacing: 2px;
    }
    .summary-box {
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
      border: 3px double #000;
      border-radius: 12px;
      padding: 30px;
      margin: 40px 0;
      text-align: center;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
      position: relative;
      overflow: hidden;
    }
    .summary-box::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, #000 0%, #333 100%);
    }
    .summary-label {
      font-size: 14px;
      color: #000;
      font-weight: 700;
      text-transform: uppercase;
      margin-bottom: 12px;
      letter-spacing: 1px;
    }
    .summary-value {
      font-size: 48px;
      font-weight: 900;
      color: #000;
      margin: 15px 0;
      font-family: 'Arial', sans-serif;
      letter-spacing: -1px;
    }
    .section-title {
      background: #000;
      color: white;
      padding: 12px 18px;
      font-size: 14px;
      font-weight: 700;
      margin: 30px 0 15px 0;
      border-radius: 4px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .data-table {
      width: 100%;
      border-collapse: collapse;
      margin: 15px 0;
      font-size: 12px;
      border: 2px solid #000;
    }
    .data-table thead {
      background: #000;
      color: white;
    }
    .data-table th {
      padding: 12px;
      text-align: left;
      font-weight: 700;
      border: 1px solid #333;
      letter-spacing: 0.5px;
    }
    .data-table td {
      padding: 10px 12px;
      border: 1px solid #ccc;
    }
    .data-table tbody tr:nth-child(even) {
      background: #f8f9fa;
    }
    .data-table tbody tr:hover {
      background: #e9ecef;
    }
    .total-row {
      background: #000 !important;
      color: white !important;
      font-weight: 700;
      letter-spacing: 0.5px;
    }
    .lawyer-info {
      background: #f8f9fa;
      border: 2px solid #000;
      border-radius: 8px;
    }
    .footer {
      margin-top: 30px;
      text-align: center;
      font-size: 11px;
      color: #475467;
      border-top: 1px solid #e2e8f0;
      padding-top: 14px;
    }
    .print-btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      background: #0f172a;
      color: #fff;
      border: none;
      border-radius: 999px;
      padding: 12px 24px;
      font-weight: 600;
      cursor: pointer;
      margin-top: 24px;
    }
    @media print {
      body { background: #fff; }
      .wrapper { box-shadow: none; border: none; }
      .print-btn { display: none; }
    }
  </style>
</head>
<body>
  <div class="report-container">
    <div class="hero-box">
      <h1>Relat√≥rio de Honor√°rios ‚Äì IRPF</h1>
      <div class="year">${year}</div>
      <p>Emitido em ${issueDate}</p>
    </div>
    <div class="summary-box">
      <div class="summary-label">Total de honor√°rios declarados</div>
      <div class="summary-value">${formatCurrency(totalReceived)}</div>
      <p style="margin-top:6px; color:#475467; font-size:12px;">${numberToWords(totalReceived)}</p>
    </div>
    <h2 class="section-title">Dados do profissional</h2>
    <table>
      <tbody>
        <tr>
          <th style="width:35%;">Nome</th>
          <td>${lawyerName}</td>
        </tr>
        <tr>
          <th>OAB</th>
          <td>${lawyerOab}/${lawyerState}</td>
        </tr>
        <tr>
          <th>E-mail profissional</th>
          <td>${lawyerEmail}</td>
        </tr>
      </tbody>
    </table>
    <h2 class="section-title">Resumo por cliente / fonte pagadora</h2>
    <table>
      <thead>
        <tr>
          <th>Cliente</th>
          <th>CPF/CNPJ</th>
          <th style="text-align:center;">Pagamentos</th>
          <th style="text-align:right;">Total</th>
        </tr>
      </thead>
      <tbody>
        ${Array.from(clientPayments.entries()).map(([clientId, entry]) => {
          const clientName = entry.client?.full_name || (entry.client as any)?.name || 'Cliente n√£o identificado';
          const clientCpf = (entry.client as any)?.cpf || (entry.client as any)?.document || 'N√£o informado';
          return `
          <tr>
            <td>${clientName}</td>
            <td>${clientCpf}</td>
            <td style="text-align:center;">${entry.payments.length}</td>
            <td class="amount">${formatCurrency(entry.total)}</td>
          </tr>`;
        }).join('')}
        <tr class="total-row">
          <td colspan="3" style="text-align:right;">Total geral</td>
          <td class="amount">${formatCurrency(totalReceived)}</td>
        </tr>
      </tbody>
    </table>
    <h2 class="section-title">Resumo mensal</h2>
    <table>
      <thead>
        <tr>
          <th>M√™s</th>
          <th style="text-align:center;">Pagamentos</th>
          <th style="text-align:right;">Total</th>
        </tr>
      </thead>
      <tbody>
        ${Array.from({ length: 12 }, (_, i) => {
          const month = i + 1;
          const monthPayments = allInstallmentsYear.filter(inst => inst.payment_date && (new Date(inst.payment_date).getMonth() + 1) === month);
          const monthTotal = monthPayments.reduce((sum, inst) => {
            if (!inst.agreement) return sum;
            return sum + (inst.agreement.fee_value / inst.agreement.installments_count);
          }, 0);
          const monthName = new Date(year, i, 1).toLocaleDateString('pt-BR', { month: 'long' });
          return `
          <tr>
            <td>${monthName.charAt(0).toUpperCase() + monthName.slice(1)}</td>
            <td style="text-align:center;">${monthPayments.length}</td>
            <td class="amount">${formatCurrency(monthTotal)}</td>
          </tr>`;
        }).join('')}
        <tr class="total-row">
          <td>Total anual</td>
          <td style="text-align:center;">${allInstallmentsYear.length}</td>
          <td class="amount">${formatCurrency(totalReceived)}</td>
        </tr>
      </tbody>
    </table>
    <h2 class="section-title">Instru√ß√µes para declara√ß√£o</h2>
    <div class="notes-box">
      <ul style="margin-left:18px; line-height:1.8;">
        <li>Declarar como <strong>Rendimentos Tribut√°veis Recebidos de Pessoa F√≠sica</strong>.</li>
        <li>Manter este relat√≥rio e os recibos arquivados por, no m√≠nimo, 5 anos.</li>
        <li>Utilizar CPF/CNPJ de cada cliente listado como fonte pagadora.</li>
        <li>Apresentar este documento em conjunto com os comprovantes, se solicitado pela Receita Federal.</li>
        <li>Verificar obrigatoriedade de Carn√™-Le√£o conforme legisla√ß√£o vigente.</li>
      </ul>
      <p style="margin-top:12px; font-size:12px; color:#c2410c;"><strong>Aten√ß√£o:</strong> Relat√≥rio informativo. Consulte um contador para orienta√ß√µes espec√≠ficas.</p>
    </div>
    <div class="footer">
      Documento emitido em ${issueDate}. Sistema de Gest√£o Financeira.
      <p>Guarde este relat√≥rio junto com os recibos individuais para comprova√ß√£o fiscal.</p>
    </div>
  </div>

  <button class="print-button no-print" onclick="window.print()">üñ®Ô∏è Imprimir Relat√≥rio</button>
</body>
</html>

    <div class="footer">
      <p><strong>Este documento foi gerado automaticamente pelo sistema de gest√£o financeira.</strong></p>
      <p>Guarde este relat√≥rio junto com os recibos individuais para comprova√ß√£o fiscal.</p>
      <p style="margin-top: 10px;">Documento gerado em ${new Date().toLocaleString('pt-BR')}</p>
    </div>
  </div>

  <button class="print-button no-print" onclick="window.print()">üñ®Ô∏è Imprimir Relat√≥rio</button>
</body>
</html>`;

      const blob = new Blob([html], { type: 'text/html' });
      const url = URL.createObjectURL(blob);
      window.open(url, '_blank');
      
      toast.success('Relat√≥rio gerado', 'Relat√≥rio de IR aberto em nova aba');
    } catch (err: any) {
      toast.error('Erro ao gerar relat√≥rio', err.message);
    }
  };

  const handlePreviousMonth = () => {
    const date = new Date(`${activeMonth}-01T00:00:00`);
    date.setMonth(date.getMonth() - 1);
    setActiveMonth(date.toISOString().slice(0, 7));
  };

  const handleNextMonth = () => {
    const date = new Date(`${activeMonth}-01T00:00:00`);
    date.setMonth(date.getMonth() + 1);
    setActiveMonth(date.toISOString().slice(0, 7));
  };

  const formatMonthYear = (monthStr: string) => {
    const date = new Date(`${monthStr}-01T00:00:00`);
    return date.toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' });
  };

  const buildScheduleFromForm = () => {
    if (!formData.firstDueDate) {
      return [] as { number: number; dueDate: string; value: number }[];
    }

    if (formData.paymentType === 'upfront') {
      return [
        {
          number: 1,
          dueDate: formData.firstDueDate,
          value: Number(formData.totalValue || 0),
        },
      ];
    }

    if (formData.customInstallments.length) {
      return formData.customInstallments.map((item, index) => ({
        number: index + 1,
        dueDate: item.dueDate || formData.firstDueDate,
        value: Number(item.value || 0),
      }));
    }

    const schedule: { number: number; dueDate: string; value: number }[] = [];
    const total = Number(formData.totalValue || 0);
    const count = Number(formData.installmentsCount || '0') || 1;
    const baseDate = new Date(formData.firstDueDate);
    const installmentValue = count > 0 ? total / count : total;

    for (let i = 0; i < count; i++) {
      const dueDate = new Date(baseDate);
      dueDate.setMonth(dueDate.getMonth() + i);
      schedule.push({
        number: i + 1,
        dueDate: dueDate.toISOString().split('T')[0],
        value: Number(installmentValue.toFixed(2)),
      });
    }

    return schedule;
  };

  const createCalendarEventsForInstallments = async (
    agreement: Agreement,
    schedule: { number: number; dueDate: string; value: number }[]
  ) => {
    if (!schedule.length) return;
    const clientName = getClientName(agreement.client_id);

    try {
      await Promise.all(
        schedule.map((item) =>
          calendarService.createEvent({
            title: `Recebimento ${clientName} - Parcela ${item.number}`,
            description: `Acordo: ${agreement.title}\nParcela ${item.number}/${schedule.length}\nValor: ${formatCurrency(item.value)}\n[agreement_id:${agreement.id}] [installment:${item.number}]`,
            event_type: 'payment',
            start_at: `${item.dueDate}T00:00:00`,
            notify_minutes_before: 60,
            client_id: agreement.client_id,
            process_id: agreement.process_id ?? undefined,
          })
        )
      );
    } catch (error: any) {
      toast.error('Calend√°rio', 'N√£o foi poss√≠vel agendar os recebimentos');
    }
  };

  const updateCalendarEventStatus = async (
    agreementId: string,
    installmentNumber: number,
    status: 'pendente' | 'concluido' | 'cancelado',
    paymentDate?: string
  ) => {
    try {
      const events = await calendarService.listEvents(['payment']);
      const target = events.find(
        (event) =>
          event.description?.includes(`[agreement_id:${agreementId}]`) &&
          event.description?.includes(`[installment:${installmentNumber}]`)
      );

      if (!target) return;

      await calendarService.updateEvent(target.id, {
        status,
        start_at: paymentDate ? `${paymentDate}T00:00:00` : target.start_at,
        description: target.description,
      });
    } catch (_) {
      // Silenciar erros de sincroniza√ß√£o do calend√°rio para n√£o interromper fluxo principal
    }
  };

  const ensureOverdueDeadlines = async (agreement: Agreement, installmentsList: Installment[]) => {
    try {
      const events = await calendarService.listEvents(['deadline']);
      await Promise.all(
        installmentsList
          .filter((inst) => {
            const dueDate = new Date(inst.due_date);
            const threshold = new Date();
            threshold.setDate(threshold.getDate() - 2);
            return inst.status === 'pendente' && dueDate < threshold;
          })
          .map(async (inst) => {
            const exists = events.some(
              (event) =>
                event.description?.includes(`[agreement_id:${agreement.id}]`) &&
                event.description?.includes(`[installment:${inst.installment_number}]`) &&
                event.description?.includes('[inadimplencia]')
            );

            if (exists) return;

            const clientName = getClientName(agreement.client_id);
            const deadlineDate = new Date(inst.due_date);
            deadlineDate.setDate(deadlineDate.getDate() + 2);

            await calendarService.createEvent({
              title: `Prazo: Den√∫ncia de inadimpl√™ncia - ${clientName}`,
              description: `Acordo: ${agreement.title}\nParcela ${inst.installment_number}/${agreement.installments_count}\nValor: ${formatCurrency(inst.value)}\n[inadimplencia] [agreement_id:${agreement.id}] [installment:${inst.installment_number}]`,
              event_type: 'deadline',
              start_at: `${deadlineDate.toISOString().split('T')[0]}T00:00:00`,
              notify_minutes_before: 60,
              client_id: agreement.client_id,
              process_id: agreement.process_id ?? undefined,
            });
          })
      );
    } catch (_) {
      // Silenciar erros de calend√°rio
    }
  };

  const handleGenerateReceipt = (agreement: Agreement, installment?: Installment) => {
    const client = clients.find(c => c.id === agreement.client_id);
    const clientName = client?.full_name || (client as any)?.name || 'Cliente n√£o encontrado';
    const clientCpf = (client as any)?.cpf || (client as any)?.document || '';
    const clientAddress = (client as any)?.address || '';
    const issueDate = new Date();
    const year = issueDate.getFullYear();
    const issueDateFormatted = issueDate.toLocaleDateString('pt-BR', { day: '2-digit', month: 'long', year: 'numeric' });
    const amount = installment ? installment.paid_value ?? installment.value : agreement.fee_value;
    const amountInWords = numberToWords(amount || 0);
    const receiptNumber = `REC-${issueDate.getFullYear()}-${String(issueDate.getMonth() + 1).padStart(2, '0')}-${String(issueDate.getDate()).padStart(2, '0')}-${String(issueDate.getHours()).padStart(2, '0')}${String(issueDate.getMinutes()).padStart(2, '0')}${String(issueDate.getSeconds()).padStart(2, '0')}`;
    
    // Dados fixos do advogado
    const lawyerName = 'PEDRO RODRIGUES MONTALVAO NETO';
    const lawyerOab = '30.021';
    const lawyerState = 'MT';
    const lawyerEmail = 'pedro@advcuiaba.com';
    const lawyerTitle = `Dr. ${lawyerName}`;
    
    const paymentMethod = installment?.payment_method
      ? installment.payment_method === 'pix' ? 'PIX'
      : installment.payment_method === 'transferencia' ? 'Transfer√™ncia Banc√°ria'
      : installment.payment_method === 'dinheiro' ? 'Dinheiro'
      : installment.payment_method === 'cartao_credito' ? 'Cart√£o de Cr√©dito'
      : installment.payment_method === 'cartao_debito' ? 'Cart√£o de D√©bito'
      : installment.payment_method === 'cheque' ? 'Cheque'
      : 'N√£o especificado'
      : 'N√£o especificado';
    
    const description = installment
      ? `Honor√°rios advocat√≠cios referente √† parcela ${installment.installment_number}/${agreement.installments_count} do acordo "${agreement.title}".`
      : `Honor√°rios advocat√≠cios referente ao acordo "${agreement.title}".`;
    
    const serviceDescription = agreement.description || 'Servi√ßos advocat√≠cios prestados conforme contrato de honor√°rios.';

    const html = `<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Recibo de Honor√°rios - ${receiptNumber}</title>
  <style>
    @page { size: A4; margin: 18mm; }
    @media print {
      body { background: #fff; }
      .wrapper { box-shadow: none; border: none; }
      .print-btn { display: none; }
    }
    body {
      font-family: 'Georgia', 'Times New Roman', serif;
      background: #fff;
      color: #000;
      margin: 0;
      padding: 0;
      line-height: 1.5;
    }
    .wrapper {
      max-width: 760px;
      margin: 0 auto;
      background: #fff;
      padding: 32px 38px;
      border: 2px solid #000;
      box-shadow: 0 6px 18px rgba(0,0,0,0.12);
    }
    .doc-header {
      text-align: center;
      border-bottom: 3px double #000;
      padding-bottom: 18px;
      margin-bottom: 24px;
    }
    .doc-header h1 {
      font-size: 22px;
      letter-spacing: 3px;
      text-transform: uppercase;
      margin: 0;
      font-weight: 700;
    }
    .doc-header p {
      margin: 8px 0 0;
      color: #333;
      font-size: 12px;
    }
    .section {
      margin-bottom: 18px;
    }
    .section-title {
      font-size: 11px;
      letter-spacing: 1px;
      text-transform: uppercase;
      color: #000;
      font-weight: 700;
      margin-bottom: 10px;
      border-bottom: 1px solid #000;
      padding-bottom: 4px;
    }
    .section p {
      font-size: 13px;
      color: #000;
      margin: 4px 0;
    }
    .amount-box {
      border: 3px double #000;
      padding: 22px;
      text-align: center;
      margin: 24px 0;
      background: #f8f9fa;
    }
    .amount-box span {
      display: block;
      font-size: 36px;
      font-weight: 900;
      letter-spacing: 1px;
      margin-bottom: 8px;
      color: #000;
    }
    .amount-box p {
      font-size: 12px;
      color: #333;
      margin-top: 8px;
      font-style: italic;
    }
    .signature {
      margin-top: 32px;
      text-align: center;
    }
    .signature-line {
      width: 240px;
      border-top: 2px solid #000;
      margin: 0 auto 10px;
    }
    .signature p {
      font-size: 13px;
      color: #000;
      margin: 4px 0;
    }
    .footer {
      margin-top: 28px;
      font-size: 11px;
      color: #666;
      text-align: center;
      border-top: 1px dashed #999;
      padding-top: 12px;
    }
    .print-btn {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: #000;
      color: white;
      border: none;
      border-radius: 999px;
      padding: 10px 24px;
      font-weight: 600;
      cursor: pointer;
      margin-top: 18px;
      transition: all 0.3s;
    }
    .print-btn:hover {
      background: #333;
      transform: translateY(-2px);
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 8px;
    }
    td {
      padding: 4px 0;
      font-size: 12px;
      vertical-align: top;
    }
    td:first-child {
      font-weight: 600;
      width: 32%;
      color: #000;
    }
  </style>
</head>
<body>
  <div class="wrapper">
    <div class="doc-header">
      <h1>${receiptNumber}</h1>
      <p>RECIBO DE HONOR√ÅRIOS ADVOCAT√çCIOS</p>
      <p style="margin-top: 12px;">${issueDateFormatted}</p>
    </div>
    
    <div class="section">
      <div class="section-title">Profissional</div>
      <table>
        <tr>
          <td>Nome:</td>
          <td>${lawyerName}</td>
        </tr>
        <tr>
          <td>OAB:</td>
          <td>${lawyerOab}/${lawyerState}</td>
        </tr>
        <tr>
          <td>E-mail:</td>
          <td>${lawyerEmail}</td>
        </tr>
      </table>
    </div>
    
    <div class="section">
      <div class="section-title">Cliente / Pagador</div>
      <table>
        <tr>
          <td>Nome:</td>
          <td>${clientName}</td>
        </tr>
        ${clientCpf ? `<tr><td>CPF/CNPJ:</td><td>${clientCpf}</td></tr>` : ''}
        ${clientAddress ? `<tr><td>Endere√ßo:</td><td>${clientAddress}</td></tr>` : ''}
      </table>
    </div>
    
    <div class="amount-box">
      <span>${formatCurrency(amount)}</span>
      <p>${amountInWords}</p>
    </div>
    
    <div class="section">
      <div class="section-title">Referente a</div>
      <p>${description}</p>
      <p style="font-size:12px; color:#555; margin-top:10px;">${serviceDescription}</p>
    </div>
    
    <div class="section">
      <div class="section-title">Forma de Pagamento</div>
      <p>${paymentMethod}</p>
    </div>
    
    <div class="signature">
      <div class="signature-line"></div>
      <p style="font-weight:700; margin-top:8px;">${lawyerName}</p>
      <p style="font-weight:600;">OAB/${lawyerState} ${lawyerOab}</p>
    </div>
    
    <div class="footer">
      <p>Documento emitido em ${issueDateFormatted}.</p>
      <p style="margin-top:6px;">Guarde este recibo para fins cont√°beis e fiscais por no m√≠nimo 5 anos.</p>
    </div>
    
    <div style="text-align:center;">
      <button class="print-btn" onclick="window.print()">Imprimir Recibo</button>
    </div>
  </div>
</body>
</html>`;

    const blob = new Blob([html], { type: 'text/html' });
    const url = URL.createObjectURL(blob);
    window.open(url, '_blank');
  };

  
  const handleAddDeadline = async (agreement: Agreement) => {
    if (!installments.length) {
      toast.info('Acordo', 'Sem parcelas para gerar prazo');
      return;
    }

    const nextPending = installments.find((inst) => inst.status !== 'pago');
    if (!nextPending) {
      toast.info('Acordo', 'Todas as parcelas j√° foram quitadas');
      return;
    }

    try {
      const clientName = getClientName(agreement.client_id);
      const deadlineDate = new Date(nextPending.due_date);
      deadlineDate.setDate(deadlineDate.getDate() + 2);

      await calendarService.createEvent({
        title: `Prazo interno - ${clientName}`,
        description: `Monitorar pagamento da parcela ${nextPending.installment_number}/${agreement.installments_count} do acordo "${agreement.title}".\n[agreement_id:${agreement.id}] [installment:${nextPending.installment_number}]`,
        event_type: 'deadline',
        start_at: `${deadlineDate.toISOString().split('T')[0]}T00:00:00`,
        notify_minutes_before: 60,
        client_id: agreement.client_id,
        process_id: agreement.process_id ?? undefined,
      });

      toast.success('Prazo criado', 'O prazo foi adicionado ao calend√°rio');
    } catch (error: any) {
      toast.error('Prazo', 'N√£o foi poss√≠vel adicionar o prazo ao calend√°rio');
    }
  };

  const handleExportAgreement = (agreement: Agreement) => {
    const clientName = getClientName(agreement.client_id);
    const payload = {
      agreement,
      clientName,
      generatedAt: new Date().toISOString(),
    };

    const blob = new Blob([JSON.stringify(payload, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `acordo-${agreement.id}.json`;
    link.click();
    URL.revokeObjectURL(url);
    toast.success('Exporta√ß√£o', 'Dados exportados com sucesso');
  };

  const deleteCalendarEventsForAgreement = async (agreementId: string) => {
    try {
      const events = await calendarService.listEvents(['payment', 'deadline']);
      const related = events.filter((event) => event.description?.includes(`[agreement_id:${agreementId}]`));
      await Promise.all(related.map((event) => calendarService.deleteEvent(event.id)));
    } catch (_) {
      // silenciar erros de limpeza para n√£o travar fluxo de exclus√£o
    }
  };

  const handleDeleteAgreement = async (agreement: Agreement) => {
    const confirmed = window.confirm('Tem certeza que deseja excluir este acordo? Esta a√ß√£o apagar√° todas as parcelas relacionadas.');
    if (!confirmed) return;

    try {
      await deleteCalendarEventsForAgreement(agreement.id);
      await financialService.deleteAgreement(agreement.id);
      toast.success('Acordo exclu√≠do', 'O acordo e suas parcelas foram removidos');

      if (selectedAgreement?.id === agreement.id) {
        handleCloseDetails();
      }

      await loadData();
    } catch (err: any) {
      toast.error('Erro ao excluir acordo', err.message);
    }
  };

  if (loading) {
    return (
      <div className="flex items-center justify-center h-96">
        <div className="flex flex-col items-center gap-4">
          <Loader2 className="w-8 h-8 text-emerald-600 animate-spin" />
          <p className="text-slate-600">Carregando dados financeiros...</p>
        </div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-slate-50">
      {/* Header minimalista e limpo */}
      <div className="bg-white border-b border-slate-200">
        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
          <div className="flex items-center justify-between h-16">
            <div className="flex items-center gap-3">
              <div className="p-2 bg-emerald-50 rounded-lg">
                <PiggyBank className="w-5 h-5 text-emerald-600" />
              </div>
              <div>
                <h1 className="text-lg font-semibold text-slate-900">Financeiro</h1>
                <p className="text-xs text-slate-500">Acordos ‚Ä¢ {agreements.length} registros</p>
              </div>
            </div>
            
            {/* Menu de navega√ß√£o */}
            <div className="flex items-center gap-1">
              <button
                onClick={() => setActiveView('overview')}
                className={`px-3 py-1.5 text-sm font-medium rounded-lg transition ${
                  activeView === 'overview'
                    ? 'bg-emerald-100 text-emerald-700'
                    : 'text-slate-600 hover:text-slate-900 hover:bg-slate-100'
                }`}
              >
                <Activity className="w-4 h-4 inline mr-1" />
                Vis√£o Geral
              </button>
              <button
                onClick={() => setActiveView('agreements')}
                className={`px-3 py-1.5 text-sm font-medium rounded-lg transition ${
                  activeView === 'agreements'
                    ? 'bg-emerald-100 text-emerald-700'
                    : 'text-slate-600 hover:text-slate-900 hover:bg-slate-100'
                }`}
              >
                <FileText className="w-4 h-4 inline mr-1" />
                Acordos
              </button>
              <button
                onClick={() => setActiveView('analytics')}
                className={`px-3 py-1.5 text-sm font-medium rounded-lg transition ${
                  activeView === 'analytics'
                    ? 'bg-emerald-100 text-emerald-700'
                    : 'text-slate-600 hover:text-slate-900 hover:bg-slate-100'
                }`}
              >
                <BarChart3 className="w-4 h-4 inline mr-1" />
                Analytics
              </button>
            </div>
            
            {/* A√ß√µes principais */}
            <div className="flex items-center gap-2">
              <button
                onClick={handleOpenModal}
                className="inline-flex items-center gap-2 bg-emerald-600 hover:bg-emerald-700 text-white text-sm font-medium px-4 py-2 rounded-lg transition"
              >
                <PlusCircle className="w-4 h-4" />
                Novo Acordo
              </button>
              
              {/* Menu de ferramentas */}
              <div className="relative">
                <button
                  onClick={() => setShowToolsMenu(!showToolsMenu)}
                  className="p-2 text-slate-600 hover:text-slate-900 hover:bg-slate-100 rounded-lg transition"
                >
                  <MoreHorizontal className="w-5 h-5" />
                </button>
                {showToolsMenu && (
                  <div className="absolute right-0 mt-2 w-56 bg-white rounded-lg shadow-lg border border-slate-200 z-50">
                    <div className="py-1">
                      <button
                        onClick={() => {
                          setIsIRModalOpen(true);
                          setShowToolsMenu(false);
                        }}
                        className="w-full text-left px-4 py-2 text-sm text-slate-700 hover:bg-slate-50 flex items-center gap-2"
                      >
                        <FileSpreadsheet className="w-4 h-4" />
                        Relat√≥rio IR
                      </button>
                      <div className="border-t border-slate-100 my-1"></div>
                      <button
                        onClick={() => {
                          setShowSettingsPanel(!showSettingsPanel);
                          setShowToolsMenu(false);
                        }}
                        className="w-full text-left px-4 py-2 text-sm text-slate-700 hover:bg-slate-50 flex items-center gap-2"
                      >
                        <Settings className="w-4 h-4" />
                        Configura√ß√µes
                      </button>
                    </div>
                  </div>
                )}
              </div>
            </div>
          </div>
        </div>
      </div>
      
      {/* Conte√∫do principal */}
      <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
        {/* Vis√£o Geral */}
        {activeView === 'overview' && (
          <div className="space-y-6">
            {/* Navega√ß√£o de m√™s */}
            <div className="bg-white rounded-lg border border-slate-200 p-4">
              <div className="flex items-center justify-between mb-3">
                <h2 className="text-sm font-semibold text-slate-900">Per√≠odo Ativo</h2>
              </div>
              <div className="flex items-center gap-2">
                <button
                  onClick={handlePreviousMonth}
                  className="p-2 hover:bg-slate-100 rounded-lg transition"
                >
                  <ChevronLeft className="w-4 h-4 text-slate-600" />
                </button>
                <span className="text-lg font-medium text-slate-900 min-w-[200px] text-center capitalize">
                  {formatMonthYear(activeMonth)}
                </span>
                <button
                  onClick={handleNextMonth}
                  className="p-2 hover:bg-slate-100 rounded-lg transition"
                >
                  <ChevronRight className="w-4 h-4 text-slate-600" />
                </button>
              </div>
            </div>

            {/* Estat√≠sticas financeiras */}
            <div className="grid grid-cols-2 sm:grid-cols-4 gap-4">
              <div className="bg-white rounded-lg border border-slate-200 p-4">
                <div className="flex items-center justify-between mb-2">
                  <span className="text-xs font-medium text-slate-600">A Receber</span>
                  <TrendingUp className="w-4 h-4 text-emerald-600" />
                </div>
                <p className="text-2xl font-bold text-slate-900">{formatCurrency(stats?.monthly_fees || 0)}</p>
              </div>
              
              <div className="bg-white rounded-lg border border-slate-200 p-4">
                <div className="flex items-center justify-between mb-2">
                  <span className="text-xs font-medium text-slate-600">Recebido</span>
                  <CheckCircle className="w-4 h-4 text-emerald-600" />
                </div>
                <p className="text-2xl font-bold text-slate-900">{formatCurrency(stats?.monthly_fees_received || 0)}</p>
              </div>
              
              <div className="bg-white rounded-lg border border-slate-200 p-4">
                <div className="flex items-center justify-between mb-2">
                  <span className="text-xs font-medium text-slate-600">Pendente</span>
                  <Clock className="w-4 h-4 text-amber-600" />
                </div>
                <p className="text-2xl font-bold text-slate-900">{formatCurrency(stats?.monthly_fees_pending || 0)}</p>
              </div>
              
              <div className="bg-white rounded-lg border border-slate-200 p-4">
                <div className="flex items-center justify-between mb-2">
                  <span className="text-xs font-medium text-slate-600">Vencido</span>
                  <AlertCircle className="w-4 h-4 text-red-600" />
                </div>
                <p className="text-2xl font-bold text-slate-900">{formatCurrency(stats?.overdue_installments || 0)}</p>
              </div>
            </div>
          </div>
        )}
        
        {/* Acordos */}
        {activeView === 'agreements' && (
          <div className="space-y-6">
            <div className="bg-white rounded-lg border border-slate-200 p-4">
              <h2 className="text-lg font-semibold text-slate-900 mb-4">Lista de Acordos</h2>
              <p className="text-slate-600">Conte√∫do da lista de acordos ser√° implementado aqui...</p>
            </div>
          </div>
        )}
        
        {/* Analytics */}
        {activeView === 'analytics' && (
          <div className="space-y-6">
            <div className="bg-white rounded-lg border border-slate-200 p-4">
              <h2 className="text-lg font-semibold text-slate-900 mb-4">Analytics Financeiro</h2>
              <p className="text-slate-600">Relat√≥rios e m√©tricas ser√£o implementados aqui...</p>
            </div>
          </div>
        )}
      </div>
      
      {/* Painel de configura√ß√µes */}
      {showSettingsPanel && (
        <div className="fixed inset-0 z-50" onClick={() => setShowSettingsPanel(false)}>
          <div className="absolute top-20 right-4 w-80 bg-white rounded-lg shadow-lg border border-slate-200 p-4">
            <h3 className="text-lg font-semibold text-slate-900 mb-4">Configura√ß√µes</h3>
            <div className="space-y-4">
              <div>
                <label className="block text-sm font-medium text-slate-700 mb-2">
                  Configura√ß√µes do m√≥dulo financeiro
                </label>
                <p className="text-sm text-slate-500">Configura√ß√µes espec√≠ficas ser√£o implementadas aqui.</p>
              </div>
            </div>
          </div>
        </div>
      )}
    </div>
  );
};

export default FinancialModule;
